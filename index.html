<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Loan Repayment Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        /* Custom scrollbar for better look on the table */
        .table-container {
            max-height: 50vh; /* Limit height for long lists */
            overflow-y: auto;
        }
        .table-container::-webkit-scrollbar {
            width: 8px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div id="app-container" class="max-w-6xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-blue-800">Wife's Loan Tracker (Local Data)</h1>
            <p class="text-lg text-gray-600 mt-2">Track the principal amount and date-wise repayments. Data is stored in your browser.</p>
            <p id="user-info" class="text-xs text-gray-400 mt-1">Status: Using Local Browser Storage</p>
        </header>

        <!-- Input and Summary Card -->
        <div class="bg-white shadow-xl rounded-xl p-6 mb-8 border border-gray-200">
            <h2 class="text-2xl font-semibold mb-6 text-blue-700">Initial Loan Details</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                <!-- Loan Amount -->
                <div class="flex flex-col">
                    <label for="loan-amount" class="text-sm font-medium text-gray-700 mb-1">Initial Loan Amount</label>
                    <input type="number" id="loan-amount" value="30000" min="1" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="e.g., 30000">
                </div>
                
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                    <button onclick="saveLoanAmount()" class="w-full sm:w-auto bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out transform hover:scale-[1.01] active:scale-[0.99]">
                        Save Initial Amount
                    </button>
                    <!-- Load button is kept for consistency but mainly loads on page refresh -->
                    <button onclick="loadAndRenderData()" class="w-full sm:w-auto bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out transform hover:scale-[1.01] active:scale-[0.99]">
                        Reload Data
                    </button>
                </div>
            </div>

            <div id="message-box" class="mt-4 p-3 rounded-lg text-sm transition-opacity duration-300 opacity-0 hidden"></div>

            <!-- Calculated Summary -->
            <div id="summary" class="mt-8 pt-6 border-t border-gray-200">
                <h3 class="text-xl font-semibold text-blue-700 mb-4">Current Status</h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg shadow-inner">
                        <p class="text-sm text-gray-600">Initial Loan</p>
                        <p id="initial-loan-output" class="text-2xl font-bold text-gray-800 mt-1">$0.00</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg shadow-inner">
                        <p class="text-sm text-gray-600">Total Repaid</p>
                        <p id="total-repaid-output" class="text-2xl font-bold text-green-600 mt-1">$0.00</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg shadow-inner">
                        <p class="text-sm text-gray-600">Remaining Balance</p>
                        <p id="remaining-balance-output" class="text-2xl font-bold text-red-600 mt-1">$0.00</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Repayment Entry and History -->
        <div class="bg-white shadow-xl rounded-xl p-6 border border-gray-200">
            <h2 class="text-2xl font-semibold mb-6 text-blue-700">Record Repayment</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                 <!-- Repayment Date -->
                <div class="flex flex-col">
                    <label for="repayment-date" class="text-sm font-medium text-gray-700 mb-1">Date Paid</label>
                    <input type="date" id="repayment-date" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                </div>
                <!-- Repayment Amount -->
                <div class="flex flex-col">
                    <label for="repayment-amount" class="text-sm font-medium text-gray-700 mb-1">Amount Paid</label>
                    <input type="number" id="repayment-amount" min="1" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="e.g., 500">
                </div>
                <!-- Add Repayment Button -->
                <div class="flex items-end">
                    <button onclick="addRepayment()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out transform hover:scale-[1.01] active:scale-[0.99]">
                        Add Repayment
                    </button>
                </div>
            </div>

            <h3 class="text-xl font-semibold text-blue-700 mt-8 mb-4">Repayment History (Date Wise)</h3>
            <div class="table-container overflow-x-auto rounded-lg border border-gray-300">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-blue-100 sticky top-0 z-10">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Date</th>
                            <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Amount</th>
                            <th class="px-3 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody id="repayment-body" class="bg-white divide-y divide-gray-100">
                        <!-- Repayment rows will be inserted here -->
                        <tr id="loading-row"><td colspan="3" class="text-center py-4 text-gray-500">Loading repayments...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script type="module">
        
        // --- Local Storage Keys ---
        const STORAGE_KEY_PRINCIPAL = 'loanTracker_principal';
        const STORAGE_KEY_REPAYMENTS = 'loanTracker_repayments';

        // --- Global State ---
        let initialLoanAmount = 0;
        let repayments = [];

        window.formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
            }).format(amount);
        };
        
        // --- Message Box Handling ---
        window.showMsg = (type, message) => {
            const msgBox = document.getElementById('message-box');
            msgBox.textContent = message;
            // Clear all type classes
            msgBox.classList.remove('opacity-0', 'hidden', 'bg-red-100', 'bg-green-100', 'bg-blue-100', 'text-red-800', 'text-green-800', 'text-blue-800');

            if (type === 'success') {
                msgBox.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                msgBox.classList.add('bg-red-100', 'text-red-800');
            } else { // info
                msgBox.classList.add('bg-blue-100', 'text-blue-800');
            }
            
            // Show the message box
            setTimeout(() => { msgBox.classList.add('opacity-100'); }, 10);
            
            // Hide the message box after 5 seconds
            setTimeout(() => {
                msgBox.classList.remove('opacity-100');
                msgBox.classList.add('opacity-0');
                setTimeout(() => msgBox.classList.add('hidden'), 300);
            }, 5000);
        };

        // --- Core Logic ---

        /** Calculates and displays the summary based on current data. */
        const calculateSummary = () => {
            const totalRepaid = repayments.reduce((sum, p) => sum + p.amount, 0);
            const remainingBalance = initialLoanAmount - totalRepaid;

            document.getElementById('initial-loan-output').textContent = formatCurrency(initialLoanAmount);
            document.getElementById('total-repaid-output').textContent = formatCurrency(totalRepaid);
            document.getElementById('remaining-balance-output').textContent = formatCurrency(Math.max(0, remainingBalance));
        };

        /** Renders the repayment schedule table. */
        const renderRepayments = (repaymentList) => {
            const tbody = document.getElementById('repayment-body');
            tbody.innerHTML = '';
            
            if (repaymentList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">No repayments recorded yet.</td></tr>';
                return;
            }
            
            // Sort repayments by date (oldest first) before rendering
            repaymentList.sort((a, b) => new Date(a.date) - new Date(b.date));

            repaymentList.forEach((p, index) => {
                
                // FIX: Using the Date(year, monthIndex, day) constructor creates a Date object
                // representing midnight on that date in the local timezone, preventing the
                // UTC-to-local-time shift that caused the "yesterday" bug.
                const dateParts = p.date.split('-'); // [YYYY, MM, DD]
                // Arguments: Year, Month (0-indexed!), Day
                const displayDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                
                const row = `
                    <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-blue-50 transition duration-100">
                        <td class="px-3 py-2 text-left text-sm">${displayDate.toLocaleDateString()}</td>
                        <td class="px-3 py-2 text-right text-sm text-green-600 font-medium">${formatCurrency(p.amount)}</td>
                        <td class="px-3 py-2 text-right text-sm">
                            <button onclick="deleteRepayment('${p.id}')" class="text-red-500 hover:text-red-700 transition duration-100 font-semibold text-xs py-1 px-2 rounded-lg bg-red-100">
                                Delete
                            </button>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        };
        
        /** Loads data from localStorage and renders the entire UI. */
        window.loadAndRenderData = () => {
            try {
                // 1. Load Principal Amount
                const principalString = localStorage.getItem(STORAGE_KEY_PRINCIPAL);
                if (principalString) {
                    initialLoanAmount = parseFloat(principalString);
                    document.getElementById('loan-amount').value = initialLoanAmount;
                } else {
                    // Use the default value from the input if localStorage is empty
                    const P = parseFloat(document.getElementById('loan-amount').value);
                    initialLoanAmount = isNaN(P) ? 0 : P;
                }
                
                // 2. Load Repayments
                const repaymentsString = localStorage.getItem(STORAGE_KEY_REPAYMENTS);
                if (repaymentsString) {
                    repayments = JSON.parse(repaymentsString);
                } else {
                    repayments = [];
                }
                
                // 3. Render UI
                calculateSummary();
                renderRepayments(repayments);

            } catch (e) {
                console.error("Error loading data from localStorage:", e);
                showMsg('error', 'Error loading data from your browser storage. It might be corrupted.');
            }
        };


        // --- Local Storage CRUD for Initial Loan Amount ---

        window.saveLoanAmount = () => {
            const P = parseFloat(document.getElementById('loan-amount').value);
            if (isNaN(P) || P <= 0) { showMsg('error', 'Please enter a valid initial loan amount.'); return; }

            try {
                localStorage.setItem(STORAGE_KEY_PRINCIPAL, P.toString());
                initialLoanAmount = P;
                calculateSummary();
                showMsg('success', 'Initial loan amount saved successfully!');
            } catch (error) {
                console.error("Error saving principal to localStorage:", error);
                showMsg('error', 'Failed to save loan amount.');
            }
        };


        // --- Local Storage CRUD for Repayments ---

        window.addRepayment = () => {
            const dateStr = document.getElementById('repayment-date').value;
            const amount = parseFloat(document.getElementById('repayment-amount').value);
            
            if (!dateStr || isNaN(amount) || amount <= 0) {
                showMsg('error', 'Please enter a valid date and a positive amount.');
                return;
            }

            try {
                const newRepayment = {
                    id: crypto.randomUUID(), // Assign unique ID for deletion
                    date: dateStr, // Storing as YYYY-MM-DD string
                    amount: amount,
                    timestamp: new Date().toISOString(), 
                };
                
                repayments.push(newRepayment);
                localStorage.setItem(STORAGE_KEY_REPAYMENTS, JSON.stringify(repayments));
                
                // Update UI
                calculateSummary();
                renderRepayments(repayments);
                
                // Clear the form after successful submission
                document.getElementById('repayment-date').value = new Date().toISOString().substring(0, 10);
                document.getElementById('repayment-amount').value = '';

                showMsg('success', 'Repayment recorded successfully!');

            } catch (error) {
                console.error("Error adding repayment to localStorage: ", error);
                showMsg('error', 'Failed to record repayment.');
            }
        };
        
        window.deleteRepayment = (idToDelete) => {
            try {
                const initialLength = repayments.length;
                
                // Filter out the repayment with the matching ID
                repayments = repayments.filter(p => p.id !== idToDelete);
                
                if (repayments.length === initialLength) {
                    console.error("Repayment with ID not found:", idToDelete);
                    showMsg('error', 'Failed to find repayment to delete.');
                    return;
                }

                localStorage.setItem(STORAGE_KEY_REPAYMENTS, JSON.stringify(repayments));
                
                // Update UI
                calculateSummary();
                renderRepayments(repayments);
                
                showMsg('success', 'Repayment deleted successfully!');

            } catch (error) {
                console.error("Error deleting repayment from localStorage: ", error);
                showMsg('error', 'Failed to delete repayment.');
            }
        };

        // --- Setup Default Date and Initial Load on DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set default date for repayment input to today
            document.getElementById('repayment-date').value = new Date().toISOString().substring(0, 10);
            
            // Load all data from localStorage immediately
            loadAndRenderData();
        });

    </script>
</body>
</html>
